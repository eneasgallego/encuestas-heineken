<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../app-route/app-route.html">

<link rel="import" href="../iron-ajax/iron-ajax.html">

<link rel="import" href="../encuestas/hnk-encuesta.html">

<link rel="import" href="hnk-page.html">

<link rel="import" href="../util/hnk-base.html">
<link rel="import" href="../util/hnk-config.html">
<link rel="import" href="../util/shared-styles.html">

<link rel="import" href="../data-behaviors/hnk-data-encuesta-behavior.html">

<dom-module id="hnk-nuevaencuesta-page">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }
        </style>

        <app-route
            route="{{route}}"
            pattern="/nueva_encuesta"
        ></app-route>

        <hnk-encuesta
            encuesta="{{encuesta}}"
            on-comenzar="_onComenzar"
            on-volver="_onVolver"
        ></hnk-encuesta>

        <iron-ajax
            id="ajax"
            method="post"
            url="[[url]]"
            content-type="application/json"
            body="[[encuesta]]"
            on-response="_onResponse"
        ></iron-ajax>

    </template>

    <script>
        Polymer({
            is: 'hnk-nuevaencuesta-page',
            behaviors: [hnk.BaseBehavior, hnk.ConfigBehavior, hnk.data.DataEncuestaBehavior],
            properties: {
                usuario: Object,
                encuesta: {
                    type: Object,
                    value: function(){return {}}
                },
                url: String
            },
            observers: ['_observerUsuario(usuario)'],
            _observerUsuario: function(usuario) {
                this.encuesta = this._crearEncuesta(usuario._id);
            },
            ready: function() {
                this.getUrl(this, 'encuestas')
                        .then(function(url) {
                            this.url = url;
                        }.bind(this));
            },
            _onComenzar: function() {
                this.$.ajax.generateRequest();
            },
            _onResponse: function(e) {
                window.location.hash = '#/encuesta/' + e.detail.response._id + '/preguntas';
            }
        });
    </script>
</dom-module>
